name: Build and Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # Set default working directory for all steps
    # defaults:
    #   run:
    #     working-directory: boeygembos-app
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'  # Tell it where to find package-lock.json
      
      - name: Install dependencies
        run: npm install
      
      - name: Build
        env:
          TINA_CLIENT_ID: ${{ secrets.TINA_CLIENT_ID }}
          TINA_TOKEN: ${{ secrets.TINA_TOKEN }}
          HEAD: main
        run: npm run build
      
      # - name: Check if dist exists (DEBUG)
      #   run: |
      #     if [ -d "dist" ]; then
      #       echo "dist folder exists"
      #       ls -la dist/
      #     else
      #       echo "dist folder NOT found"
      #       echo "Current directory contents:"
      #       ls -la
      #     fi
      
      - name: Setup SSH
        working-directory: ${{ github.workspace }}  # Override for this step (need to be in root)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to VPS
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            dist/ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/opt/docker/websites/boeygembos/html/
      
      - name: Restart container
        working-directory: ${{ github.workspace }}  # Override for this step
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "cd /opt/docker/websites/boeygembos && docker compose restart"
      
      - name: Cleanup
        if: always()
        working-directory: ${{ github.workspace }}  # Override for this step
        run: rm -f ~/.ssh/deploy_key